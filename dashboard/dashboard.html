<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard M√©t√©o </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #f8fbff 100%);
            color: #2c3e50;
        }

        .header {
            background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(79, 195, 247, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.6rem;
            font-weight: 600;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            box-shadow: 0 0 10px #4caf50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .nav-tabs {
            background: white;
            border-bottom: 1px solid rgba(79, 195, 247, 0.2);
            padding: 0 2rem;
            display: flex;
            gap: 0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-btn:hover {
            color: #4fc3f7;
            background: rgba(79, 195, 247, 0.05);
        }

        .tab-btn.active {
            color: #4fc3f7;
            border-bottom-color: #4fc3f7;
            background: rgba(79, 195, 247, 0.08);
        }

        .tab-content {
            display: none;
            padding: 1.5rem;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        .overview-grid {
    height: calc(100vh - 160px);
}

.metrics-panel {
    display: grid;
    grid-template-rows: auto 1fr;
    gap: 1.5rem;
}

.current-metrics {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.8rem;
    margin-bottom: 1rem;
}

.metric-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%);
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 4px 15px rgba(79, 195, 247, 0.1);
    border: 1px solid rgba(79, 195, 247, 0.2);
}

.metric-header {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    margin-bottom: 0.8rem;
}

.metric-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.metric-info h3 {
    font-size: 0.85rem;
    color: #64748b;
    font-weight: 500;
    margin: 0;
}

.metric-value {
    font-size: 1.6rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
}

.metric-change {
    font-size: 0.8rem;
    margin-top: 0.3rem;
    display: flex;
    align-items: center;
    gap: 0.3rem;
}

.change-positive {
    color: #10b981;
}

.change-negative {
    color: #ef4444;
}

/* Section principale avec graphique et pr√©dictions */
.main-section {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
    height: 100%;
}

.main-chart {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 15px rgba(79, 195, 247, 0.1);
    border: 1px solid rgba(79, 195, 247, 0.2);
    display: flex;
    flex-direction: column;
}

.chart-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.chart-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
}

.chart-container {
    flex: 1;
    position: relative;
    min-height: 300px;
}

.sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.forecast-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 15px rgba(79, 195, 247, 0.1);
    border: 1px solid rgba(79, 195, 247, 0.2);
}

.card-title {
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 1rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.forecast-list {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.forecast-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: rgba(79, 195, 247, 0.05);
    border-radius: 8px;
    border-left: 3px solid #4fc3f7;
}

.forecast-item span {
    color: #64748b;
    font-weight: 500;
}

.forecast-item strong {
    color: #1e293b;
    font-size: 1.1rem;
}

/* Ajustements pour les √©crans plus petits */
@media (max-width: 1200px) {
    .main-section {
        grid-template-columns: 1.5fr 1fr;
        gap: 1rem;
    }
    
    .current-metrics {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 768px) {
    .main-section {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .current-metrics {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .forecast-card {
        order: -1; /* Mettre les pr√©dictions en haut sur mobile */
    }
}

/* vue analyse */

.analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            height: calc(100vh - 160px);
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(79, 195, 247, 0.1);
            border: 1px solid rgba(79, 195, 247, 0.2);
        }

        .chart-container {
            height: 300px;
            position: relative;
        }
        /* Vue Monitoring */
        .monitoring-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 1.5rem;
            height: calc(100vh - 160px);
        }

        .alerts-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .alert-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(79, 195, 247, 0.1);
            border: 1px solid rgba(79, 195, 247, 0.2);
        }

        .alert-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .alert-critical {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .alert-warning {
            background: #fff7ed;
            border-color: #f97316;
        }

        .alert-info {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .alert-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .system-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat-card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 0.3rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {

            .overview-grid,
            .monitoring-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .current-metrics {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .current-metrics {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                overflow-x: auto;
                padding: 0 1rem;
            }

            .tab-content {
                padding: 1rem;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <h1>üå§Ô∏è Dashboard M√©t√©o</h1>
        <div class="status-indicator">
            <div class="status-dot"></div>
            <span>EPT - DIC2 GIT</span>
        </div>
    </header>

    <nav class="nav-tabs">
        <button class="tab-btn active" data-tab="overview">üìä Vue d'ensemble</button>
        <button class="tab-btn" data-tab="analytics">üìà Analyses</button>
        <button class="tab-btn" data-tab="monitoring">üîç Monitoring</button>
        <!-- <button class="tab-btn" data-tab="predictions">üîÆ Pr√©dictions</button> -->
    </nav>

    <!-- Vue d'ensemble -->
   <div id="overview" class="tab-content active">
    <div class="overview-grid">
        <div class="metrics-panel">
            <div class="current-metrics">
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon" style="background: #fef3c7; color: #f59e0b;">üå°Ô∏è</div>
                        <div class="metric-info">
                            <h3>Temp√©rature Actuelle</h3>
                        </div>
                    </div>
                    <div class="metric-value">22.5¬∞C</div>
                    <div class="metric-change change-positive">Temp ressentie : 30.2¬∞C</div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon" style="background: #dbeafe; color: #3b82f6;">üíß</div>
                        <div class="metric-info">
                            <h3>Humidit√© Relative</h3>
                        </div>
                    </div>
                    <div class="metric-value">65%</div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon" style="background: #f3e8ff; color: #8b5cf6;">üå™Ô∏è</div>
                        <div class="metric-info">
                            <h3>Vitesse du Vent</h3>
                        </div>
                    </div>
                    <div class="metric-value">12 km/h</div>
                    <div class="metric-change" style="color: #64748b;">Direction: NE</div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon" style="background: #ecfdf5; color: #10b981;">üìä</div>
                        <div class="metric-info">
                            <h3>Pression Atmos.</h3>
                        </div>
                    </div>
                    <div class="metric-value">1013 hPa</div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon" style="background: #fef3c7; color: #f59e0b;">‚õÖ</div>
                        <div class="metric-info">
                            <h3>Conditions</h3>
                        </div>
                    </div>
                    <div class="metric-value">Nuageux</div>
                    <div class="metric-change">L√©g√®re pluie</div>
                </div>
            </div>

            <div class="main-section">
                <div class="main-chart">
                    <div class="chart-controls">
                        <h3 class="chart-title">√âvolution des Temp√©ratures (Pass√©/Pr√©dictions)</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="overviewChart"></canvas>
                    </div>
                </div>
                
                <div class="sidebar">
                    <div class="forecast-card">
                        <h3 class="card-title">üîÆ Pr√©dictions 4h</h3>
                        <div class="forecast-list">
                            <div class="forecast-item">
                                <span>14:00</span>
                                <strong>24.2¬∞C</strong>
                            </div>
                            <div class="forecast-item">
                                <span>15:00</span>
                                <strong>25.1¬∞C</strong>
                            </div>
                            <div class="forecast-item">
                                <span>16:00</span>
                                <strong>24.8¬∞C</strong>
                            </div>
                            <div class="forecast-item">
                                <span>17:00</span>
                                <strong>23.5¬∞C</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Vue Analytique -->
        <div id="analytics" class="tab-content">
        <div class="analytics-grid">
            <!-- Remplacement tendances hebdo par Min/Max -->
            <div class="chart-card">
                <h3 class="card-title">üìà Temp√©ratures Extr√™mes (7j)</h3>
                <div class="chart-container">
                    <canvas id="extremesChart"></canvas>
                </div>
            </div>
            
            <!-- Remplacement distribution m√©t√©o par Rose des vents -->
            <div class="chart-card">
                <h3 class="card-title">üí® Rose des Vents</h3>
                <div class="chart-container">
                    <canvas id="windChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Vue Monitoring -->
    <div id="monitoring" class="tab-content">
        <div class="monitoring-grid">
            <div class="alerts-panel">
                <div class="alert-card">
                    <h3 class="card-title">üö® Alertes Syst√®me</h3>
                    <div class="alert-list">
                        <div class="alert-item alert-warning">
                            <div class="alert-icon" style="background: #f97316;">‚ö†</div>
                            <div>
                                <strong>Retard de donn√©es</strong><br>
                                <small>Derni√®re r√©ception: il y a 12 minutes</small>
                            </div>
                        </div>
                        <div class="alert-item alert-critical">
                            <div class="alert-icon" style="background: #ef4444;">!</div>
                            <div>
                                <strong>Temp√©rature anormale</strong><br>
                                <small>Pic d√©tect√© √† 13:45 (32.1¬∞C)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert-card">
                    <h3 class="card-title">üìä M√©triques Syst√®me</h3>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="systemChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="quick-stats">
                    <h3 class="card-title">‚ö° Performance</h3>
                    <div class="system-stats">
                        <div class="stat-card">
                            <div class="stat-value">98.5%</div>
                            <div class="stat-label">Uptime</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">1.2s</div>
                            <div class="stat-label">Latence</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">5</div>
                            <div class="stat-label">Erreurs/jour</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">2.1MB</div>
                            <div class="stat-label">Taille DB</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Gestion des onglets
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const tabId = this.dataset.tab;

                // D√©sactiver tous les onglets et contenus
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                // Activer l'onglet et contenu s√©lectionn√©s
                this.classList.add('active');
                document.getElementById(tabId).classList.add('active');

                // Initialiser les graphiques si n√©cessaire
                initCharts(tabId);
            });
        });

         Chart.defaults.font.family = "'Segoe UI', sans-serif";
        Chart.defaults.color = '#64748b';

        let charts = {};

        function initCharts(tabId) {
            if (tabId === 'overview' && !charts.overview) {
                const ctx = document.getElementById('overviewChart').getContext('2d');
                charts.overview = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['10h', '11h', 'Maintenant', '13h', '14h', '15h','16h'],
                        datasets: [{
                            label: 'Temp√©rature',
                            data: [20.1, 21.5, 22.5, 23.1, 23.8, 23.5,23.4],
                            borderColor: '#4fc3f7',
                            backgroundColor: 'rgba(79, 195, 247, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            // Style diff√©rent pour les pr√©dictions
                            segment: {
                                borderColor: ctx => ctx.p1DataIndex >= 3 ? '#4fc3f780' : '#4fc3f7',
                                borderDash: ctx => ctx.p1DataIndex >= 3 ? [5, 5] : undefined
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            annotation: {
                                annotations: {
                                    lineNow: {
                                        type: 'line',
                                        xMin: 2,
                                        xMax: 2,
                                        borderColor: '#ff6b6b',
                                        borderWidth: 2,
                                        borderDash: [6, 6],
                                        label: {
                                            content: 'Maintenant',
                                            enabled: true,
                                            position: 'top'
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { 
                                ticks: { callback: value => value + '¬∞C' }
                            }
                        }
                    }
                });
            }

               if (tabId === 'analytics' && !charts.extremes) {
                // Nouveau graphique Temp√©ratures Min/Max
                const extremesCtx = document.getElementById('extremesChart').getContext('2d');
                charts.extremes = new Chart(extremesCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
                        datasets: [
                            {
                                label: 'Min',
                                data: [18.1, 19.5, 17.8, 20.2, 21.1, 19.8, 18.4],
                                backgroundColor: '#4fc3f7'
                            },
                            {
                                label: 'Max',
                                data: [25.1, 26.5, 24.8, 27.2, 28.1, 26.8, 25.4],
                                backgroundColor: '#ef4444'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                ticks: {
                                    callback: value => value + '¬∞C'
                                }
                            }
                        }
                    }
                });
                
                // Nouvelle Rose des vents
                const windCtx = document.getElementById('windChart').getContext('2d');
                charts.wind = new Chart(windCtx, {
                    type: 'radar',
                    data: {
                        labels: ['N', 'NE', 'E', 'SE', 'S', 'SO', 'O', 'NO'],
                        datasets: [{
                            label: 'Vitesse du vent (km/h)',
                            data: [8, 12, 5, 3, 4, 15, 10, 7],
                            backgroundColor: 'rgba(79, 195, 247, 0.2)',
                            borderColor: '#4fc3f7',
                            pointBackgroundColor: '#4fc3f7',
                            pointBorderColor: '#fff',
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                angleLines: {
                                    display: true
                                },
                                suggestedMin: 0
                            }
                        }
                    }
                });
            }
        
            if (tabId === 'monitoring' && !charts.system) {
                const sysCtx = document.getElementById('systemChart').getContext('2d');
                charts.system = new Chart(sysCtx, {
                    type: 'line',
                    data: {
                        labels: ['10:00', '11:00', '12:00', '13:00', '14:00'],
                        datasets: [{
                            label: 'CPU %',
                            data: [45, 52, 48, 65, 58],
                            borderColor: '#ef4444',
                            tension: 0.4
                        }, {
                            label: 'M√©moire %',
                            data: [32, 35, 38, 42, 40],
                            borderColor: '#4fc3f7',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            if (tabId === 'predictions' && !charts.prediction) {
                const predCtx = document.getElementById('predictionChart').getContext('2d');
                charts.prediction = new Chart(predCtx, {
                    type: 'line',
                    data: {
                        labels: ['Maintenant', '+1h', '+2h', '+3h', '+4h'],
                        datasets: [{
                            label: 'Pr√©diction',
                            data: [22.5, 23.1, 24.2, 23.8, 23.0],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        // Initialiser les graphiques de la vue d'ensemble au chargement
        initCharts('overview');

        // Gestion des contr√¥les temporels
        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Mise √† jour des donn√©es du graphique
                const period = this.dataset.period;
                if (charts.overview) {
                    const data = {
                        '24h': [18.5, 17.2, 21.8, 24.5, 23.2, 20.1],
                        '7j': [20.1, 21.5, 22.8, 23.2, 24.1, 22.9],
                        '30j': [19.2, 20.8, 22.1, 23.5, 21.9, 20.5]
                    };
                    charts.overview.data.datasets[0].data = data[period];
                    charts.overview.update();
                }
            });
        });

        // Simulation de mise √† jour temps r√©el
        // setInterval(() => {
        //     const temp = (Math.random() * 6 + 19).toFixed(1);
        //     document.querySelector('.metric-value').textContent = temp + '¬∞C';
        // }, 5000);

        // Rafra√Æchir les valeurs actuelles toutes les 10 min
// ============ FONCTIONS UTILITAIRES S√âCURIS√âES ============

// Affichage s√©curis√© des valeurs num√©riques
function safeDisplay(value, decimals = 1, unit = '') {
    if (value === null || value === undefined || isNaN(value)) {
        return 'N/A';
    }
    return `${value.toFixed(decimals)}${unit}`;
}

// V√©rifier la fra√Æcheur des donn√©es selon le type
function isDataFresh(timestamp, dataType = 'raw') {
    if (!timestamp) return false;
    
    const now = new Date();
    const dataTime = new Date(timestamp);
    const ageMinutes = (now - dataTime) / (1000 * 60);
    
    switch(dataType) {
        case 'raw': return ageMinutes <= 20;        // Donn√©es 10min : max 20min
        case 'hourly': return ageMinutes <= 90;     // Moyennes horaires : max 1h30
        case 'predictions': return ageMinutes <= 240; // Pr√©dictions : max 4h
        case 'daily': return ageMinutes <= 1440;    // Donn√©es journali√®res : max 24h
        default: return ageMinutes <= 30;
    }
}

// Convertir degr√©s en direction
function degToDir(deg) {
    if (deg === null || deg === undefined || isNaN(deg)) return 'N/A';
    const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SO', 'O', 'NO'];
    return dirs[Math.round(deg / 45) % 8];
}

// Mettre √† jour l'indicateur de statut
function updateStatusIndicator(isFresh, lastUpdate = null) {
    const statusDot = document.querySelector('.status-dot');
    const statusText = document.querySelector('.status-indicator span');
    
    if (isFresh) {
        statusDot.style.background = '#4caf50';
        statusDot.style.boxShadow = '0 0 10px #4caf50';
        if (lastUpdate) {
            const updateTime = new Date(lastUpdate).toLocaleTimeString('fr-FR', {
                hour: '2-digit', minute: '2-digit'
            });
            const now = new Date();
            const dateStr = now.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'long' });
            statusText.textContent = `${dateStr.charAt(0).toUpperCase() + dateStr.slice(1)} (${updateTime})`;
            // statusText.textContent = `EPT - DIC2 GIT (${updateTime})`;
        }
    } else {
        statusDot.style.background = '#ff6b6b';
        statusDot.style.boxShadow = '0 0 10px #ff6b6b';
        const now = new Date();
        const dateStr = now.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'long' });
        statusText.textContent = `${dateStr.charAt(0).toUpperCase() + dateStr.slice(1)}  (DONN√âES OBSOL√àTES)`;
        // statusText.textContent = 'EPT - DIC2 GIT (DONN√âES OBSOL√àTES)';
    }
}

// ============ MISE √Ä JOUR DES M√âTRIQUES ACTUELLES ============
async function fetchAndUpdateCurrent() {
    try {
        const res = await fetch('http://127.0.0.1:5000/api/latest-raw');
        
        if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
        }
        
        const data = await res.json();
        console.log("Donn√©es re√ßues:", data);

        // V√©rifier si on a des donn√©es
        if (!data || Object.keys(data).length === 0) {
            console.warn("Aucune donn√©e re√ßue de l'API");
            updateStatusIndicator(false);
            return;
        }

        // V√©rifier la fra√Æcheur
        const isFresh = isDataFresh(data.timestamp, 'raw');
        updateStatusIndicator(isFresh, data.timestamp);

        // Mise √† jour s√©curis√©e des m√©triques
        const metricValues = document.querySelectorAll('.metric-value');
        const metricChanges = document.querySelectorAll('.metric-change');

        // Temp√©rature
        metricValues[0].textContent = safeDisplay(data.temperature, 1, '¬∞C');
        if (metricChanges[0]) {
            metricChanges[0].textContent = `Temp ressentie : ${safeDisplay(data.feels_like, 1, '¬∞C')}`;
        }

        // Humidit√©
        if (metricValues[1]) {
            metricValues[1].textContent = safeDisplay(data.humidity, 0, '%');
        }

        // Vent
        if (metricValues[2]) {
            metricValues[2].textContent = safeDisplay(data.wind_speed, 1, ' km/h');
        }
        if (metricChanges[1]) {
            metricChanges[1].textContent = `Direction: ${degToDir(data.wind_deg)}`;
        }

        // Pression
        if (metricValues[3]) {
            metricValues[3].textContent = safeDisplay(data.pressure, 0, ' hPa');
        }

        // Conditions m√©t√©o
        if (metricValues[4]) {
            metricValues[4].textContent = data.weather_main || 'N/A';
        }
        if (metricChanges[2]) {
            metricChanges[2].textContent = data.weather_description || 'N/A';
        }

        // Si donn√©es obsol√®tes, ajouter une indication visuelle discr√®te
        const metricCards = document.querySelectorAll('.metric-card');
        metricCards.forEach(card => {
            if (!isFresh) {
                card.style.opacity = '0.7';
                card.style.border = '1px solid #ff6b6b';
            } else {
                card.style.opacity = '1';
                card.style.border = '1px solid rgba(79, 195, 247, 0.2)';
            }
        });

    } catch (error) {
        console.error("Erreur lors de la r√©cup√©ration des donn√©es actuelles:", error);
        updateStatusIndicator(false);
        
        // Afficher un message d'erreur discret
        const firstMetric = document.querySelector('.metric-value');
        if (firstMetric) {
            firstMetric.textContent = 'Erreur API';
        }
    }
}

// ============ MISE √Ä JOUR DES PR√âDICTIONS ============
async function fetchAndUpdatePredictions() {
    try {
        const res = await fetch('http://127.0.0.1:5000/api/predictions');
        
        if (!res.ok) {
            console.warn("Pas de pr√©dictions disponibles");
            return;
        }
        
        const data = await res.json();

        if (!data || Object.keys(data).length === 0) {
            console.warn("Donn√©es de pr√©diction vides");
            return;
        }

        // V√©rifier la fra√Æcheur des pr√©dictions
        const predictionsFresh = isDataFresh(data.prediction_time, 'predictions');
        
        const forecastItems = document.querySelectorAll('.forecast-item');
        
        for (let i = 0; i < 4 && i < forecastItems.length; i++) {
            const item = forecastItems[i];
            const span = item.querySelector('span');
            const strong = item.querySelector('strong');
            
            if (span && strong) {
                // Calculer l'heure pr√©dite
                const baseTime = data.prediction_time ? new Date(data.prediction_time) : new Date();
                const futureHour = new Date(baseTime.getTime() + (i + 1) * 60 * 60 * 1000);
                
                span.textContent = futureHour.toLocaleTimeString('fr-FR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const predValue = data[`h_plus_${i + 1}`];
                strong.textContent = safeDisplay(predValue, 1, '¬∞C');
                
                // Indication visuelle si pr√©dictions obsol√®tes
                if (!predictionsFresh) {
                    item.style.opacity = '0.6';
                    item.style.borderLeftColor = '#ff6b6b';
                } else {
                    item.style.opacity = '1';
                    item.style.borderLeftColor = '#4fc3f7';
                }
            }
        }

        // Mise √† jour du graphique principal avec gestion d'erreurs
        await updateMainChart(data);

    } catch (error) {
        console.error("Erreur lors de la r√©cup√©ration des pr√©dictions:", error);
    }
}

// ============ MISE √Ä JOUR DU GRAPHIQUE PRINCIPAL ============
async function updateMainChart(predictionData) {
    try {
        if (!charts.overview) return;

        // R√©cup√©rer les temp√©ratures horaires
        const tempRes = await fetch('http://127.0.0.1:5000/api/hourly-temperature');
        if (!tempRes.ok) return;
        
        const tempData = await tempRes.json();
        
        if (!tempData || tempData.length === 0) {
            console.warn("Pas de donn√©es horaires pour le graphique");
            return;
        }

        // Pr√©parer les donn√©es pass√©es (s√©curis√©es)
        const pastLabels = tempData.map(e => {
            try {
                return new Date(e.timestamp).getHours() + 'h';
            } catch {
                return 'N/A';
            }
        });
        
        const pastTemps = tempData.map(e => {
            const temp = e.temperature_avg;
            return (temp !== null && temp !== undefined && !isNaN(temp)) ? temp : null;
        });

        // Pr√©parer les pr√©dictions (s√©curis√©es)
        const predictionTemps = [];
        const predictionLabels = [];
        
        for (let i = 1; i <= 4; i++) {
            const predValue = predictionData[`h_plus_${i}`];
            predictionTemps.push((predValue !== null && predValue !== undefined && !isNaN(predValue)) ? predValue : null);
            predictionLabels.push(`+${i}h`);
        }

        // Mise √† jour du graphique
        charts.overview.data.labels = [...pastLabels, ...predictionLabels];
        charts.overview.data.datasets[0].data = [...pastTemps, ...predictionTemps];
        charts.overview.update('none'); // Animation d√©sactiv√©e pour plus de fluidit√©

    } catch (error) {
        console.error("Erreur mise √† jour graphique principal:", error);
    }
}

// ============ MISE √Ä JOUR DES ANALYSES (EXTR√äMES) ============
async function fetchAndUpdateAnalytics() {
    try {
        const res = await fetch('http://127.0.0.1:5000/api/daily-extremes');
        
        if (!res.ok) return;
        
        const data = await res.json();

        if (!data || data.length === 0) return;

        if (charts.extremes) {
            const labels = data.map(e => {
                try {
                    return new Date(e.timestamp).toLocaleDateString('fr-FR', { weekday: 'short' });
                } catch {
                    return 'N/A';
                }
            });
            
            const minTemps = data.map(e => {
                const temp = e.temperature_min;
                return (temp !== null && temp !== undefined && !isNaN(temp)) ? temp : 0;
            });
            
            const maxTemps = data.map(e => {
                const temp = e.temperature_max;
                return (temp !== null && temp !== undefined && !isNaN(temp)) ? temp : 0;
            });

            charts.extremes.data.labels = labels;
            charts.extremes.data.datasets[0].data = minTemps;
            charts.extremes.data.datasets[1].data = maxTemps;
            charts.extremes.update('none');
        }

    } catch (error) {
        console.error("Erreur lors de la r√©cup√©ration des extr√™mes:", error);
    }
}

// ============ MISE √Ä JOUR ROSE DES VENTS ============
async function fetchAndUpdateWind() {
    try {
        const res = await fetch('http://127.0.0.1:5000/api/wind-distribution');
        
        if (!res.ok) return;
        
        const data = await res.json();

        if (!data) return;

        if (charts.wind) {
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SO', 'O', 'NO'];
            const windData = directions.map(d => {
                const value = data[d];
                return (value !== null && value !== undefined && !isNaN(value)) ? value : 0;
            });

            charts.wind.data.datasets[0].data = windData;
            charts.wind.update('none');
        }

    } catch (error) {
        console.error("Erreur lors de la r√©cup√©ration des donn√©es de vent:", error);
    }
}

// ============ INITIALISATION ============
console.log("Initialisation du dashboard temps r√©el...");

// Appels initiaux
fetchAndUpdateCurrent();
fetchAndUpdatePredictions();
fetchAndUpdateAnalytics();
fetchAndUpdateWind();

// Programmation des mises √† jour automatiques
setInterval(fetchAndUpdateCurrent, 2 * 60 * 1000);           // Toutes les 2 minutes
setInterval(fetchAndUpdatePredictions, 5 * 60 * 1000);       // Toutes les 5 minutes  
setInterval(fetchAndUpdateWind, 5 * 60 * 1000);              // Toutes les 5 minutes
setInterval(fetchAndUpdateAnalytics, 15 * 60 * 1000);        // Toutes les 15 minutes

console.log("Dashboard configur√© - Mise √† jour automatique activ√©e !");
    </script>
</body>

</html>